<!doctype html>

<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BooChat-A.I</title>
  <style>
    :root{
      --bg:#070606;
      --card:#0b0b0c;
      --muted:#9aa4b2;
      --accent:#ff2d2d;
      --accent-2:#ff7a7a;
      --glass: rgba(255,255,255,0.03);
      --success:#10b981;
      --radius:14px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#050304 0%, #0b0b0c 100%);color:#fff}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}.app{
  width:100%;max-width:980px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:18px;padding:18px;display:grid;grid-template-columns:320px 1fr;gap:18px;box-shadow:0 15px 40px rgba(0,0,0,0.6);
  backdrop-filter:blur(6px);
}

/* Sidebar */
.sidebar{background:var(--card);padding:14px;border-radius:12px;display:flex;flex-direction:column;gap:12px;height:620px}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:44px;height:44px;border-radius:9px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent),#8b0000);box-shadow:0 6px 20px rgba(255,45,45,0.12), inset 0 -6px 24px rgba(0,0,0,0.45)}
.logo b{font-size:18px}
.brand h3{margin:0;font-size:16px}
.brand p{margin:0;font-size:12px;color:var(--muted)}

.controls{display:flex;gap:8px}
.btn{flex:1;padding:8px 10px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
.btn.new{background:transparent;color:var(--accent);border:1px solid rgba(255,45,45,0.12)}
.btn.clear{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}

.convo-list{overflow:auto;padding:6px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);flex:1}
.convo-item{padding:8px;border-radius:10px;display:flex;flex-direction:column;gap:4px;margin-bottom:8px;cursor:pointer}
.convo-item:hover{background:linear-gradient(90deg, rgba(255,45,45,0.03), rgba(255,255,255,0.01))}
.convo-item .title{font-weight:700;color:#fff}
.convo-item .meta{font-size:12px;color:var(--muted)}

.meta-actions{display:flex;gap:6px}
.small{font-size:12px;color:var(--muted)}

/* Chat area */
.chat{background:var(--glass);padding:18px;border-radius:12px;display:flex;flex-direction:column;height:620px}
.chat-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.chat-title{display:flex;gap:12px;align-items:center}
.chat-title h2{margin:0}
.chat-messages{flex:1;overflow:auto;padding:10px 6px;display:flex;flex-direction:column;gap:12px;margin-top:8px}

.msg{max-width:78%;padding:12px;border-radius:12px;line-height:1.4;white-space:pre-wrap}
.user{align-self:flex-end;background:linear-gradient(180deg,#2b2b2b,#1a1a1a);border:1px solid rgba(255,255,255,0.02)}
.assistant{align-self:flex-start;background:linear-gradient(180deg, rgba(255,45,45,0.06), rgba(255,45,45,0.03));border:1px solid rgba(255,45,45,0.12);box-shadow:0 6px 18px rgba(255,45,45,0.03)}

.msg .time{display:block;font-size:11px;color:var(--muted);margin-top:6px;text-align:right}

.composer{display:flex;gap:10px;margin-top:12px}
.input-wrap{flex:1;display:flex;flex-direction:column}
textarea#prompt{width:100%;min-height:96px;border-radius:12px;padding:12px;border:none;background:transparent;color:#fff;outline:none;resize:vertical}

.send-row{display:flex;gap:8px;align-items:center;margin-top:8px}
.send-btn{padding:10px 14px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));font-weight:700;cursor:pointer;box-shadow:0 6px 30px rgba(255,45,45,0.12)}
.muted-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:8px 10px;border-radius:10px;cursor:pointer}

.typing{font-style:italic;color:var(--muted)}

/* responsive */
@media (max-width:880px){
  .app{grid-template-columns:1fr;}
  .sidebar{height:auto}
  .chat{height:auto;margin-top:6px}
}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="app" role="application"><aside class="sidebar" aria-label="Sidebar">
    <div class="brand">
      <div class="logo"><b>DTN</b></div>
      <div>
        <h3>BooChat-A.I</h3>
        <p>AI nhỏ gọn — Phát triển bởi openAI và DTN.Bo</p>
      </div>
    </div>

    <div class="controls">
      <button class="btn new" id="newConvoBtn">+ Cuộc trò chuyện mới</button>
      <button class="btn clear" id="clearAllBtn">Xoá tất cả</button>
    </div>

    <div class="convo-list" id="convoList" aria-live="polite"></div>

    <div class="small" style="margin-top:6px;display:flex;justify-content:space-between;align-items:center">
      <span>Phiên bản: local • 17.5.9.1</span>
      <div style="display:flex;gap:6px">
        <button class="muted-btn" id="exportBtn">Xuất</button>
        <button class="muted-btn" id="importBtn">Nhập</button>
      </div>
    </div>
  </aside>

  <main class="chat">
    <div class="chat-header">
      <div class="chat-title">
        <h2 id="chatTitle">Cuộc trò chuyện mới</h2>
        <div class="small" id="chatMeta">Chưa có tin nhắn</div>
      </div>
      <div class="meta-actions">
        <button class="muted-btn" id="copyConvBtn">Sao chép</button>
        <button class="muted-btn" id="deleteConvBtn">Xoá</button>
      </div>
    </div>

    <div class="chat-messages" id="messages" role="log" aria-live="polite"></div>

    <div class="composer">
      <div class="input-wrap">
        <textarea id="prompt" placeholder="Gõ câu hỏi của bạn... (Enter gửi — Shift+Enter xuống dòng)"></textarea>
        <div class="send-row">
          <button class="send-btn" id="askBtn">Gửi</button>
          <button class="muted-btn" id="regenBtn">Tạo lại</button>
          <div style="flex:1;text-align:right;color:var(--muted);font-size:13px">Lưu tại thiết bị • Tải câu trả lời</div>
        </div>
      </div>
    </div>

  </main>
</div>

  </div>  <!-- Puter.js -->  <script src="https://js.puter.com/v2/"></script>  <script>
    // STORAGE KEY
    const STORAGE_KEY = 'boochat_conversations_v1';

    // DOM
    const convoListEl = document.getElementById('convoList');
    const messagesEl = document.getElementById('messages');
    const chatTitleEl = document.getElementById('chatTitle');
    const chatMetaEl = document.getElementById('chatMeta');
    const promptEl = document.getElementById('prompt');
    const askBtn = document.getElementById('askBtn');
    const newConvoBtn = document.getElementById('newConvoBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const copyConvBtn = document.getElementById('copyConvBtn');
    const deleteConvBtn = document.getElementById('deleteConvBtn');
    const regenBtn = document.getElementById('regenBtn');

    // In-memory
    let conversations = [];
    let currentConvoId = null;
    let isTyping = false;

    // Init
    function loadConversations(){
      try{
        const puterOptions = { model: 'gpt-4.1-nano', max_tokens: 1200 };
        const response = await puter.ai.chat(prompt, puterOptions);

        // Robust extractor for many Puter response shapes
        function findFirstString(obj, seen = new WeakSet()){
          if (obj == null) return null;
          if (typeof obj === 'string') return obj;
          if (typeof obj === 'number' || typeof obj === 'boolean') return String(obj);
          if (typeof obj === 'object'){
            if (seen.has(obj)) return null;
            seen.add(obj);
            if (Array.isArray(obj)){
              for (const el of obj){ const s = findFirstString(el, seen); if (s) return s; }
            } else {
              // prefer these keys when present
              const keysPriority = ['content','text','message','output','choices','parts'];
              for (const k of keysPriority){ if (obj[k] !== undefined){ const s = findFirstString(obj[k], seen); if (s) return s; } }
              for (const k in obj){ const s = findFirstString(obj[k], seen); if (s) return s; }
            }
          }
          return null;
        }

        let assistantText = null;
        if (typeof response === 'string') assistantText = response;
        else {
          // common paths returned by different APIs / SDKs
          assistantText = response?.message?.content ?? response?.message?.content?.text ?? (Array.isArray(response?.message?.content?.parts) ? response.message.content.parts.join('
') : null) ?? response?.choices?.[0]?.message?.content ?? response?.choices?.[0]?.message?.content?.text ?? response?.choices?.[0]?.text ?? response?.text ?? null;
          if (Array.isArray(assistantText)) assistantText = assistantText.join('
');
          if (!assistantText) assistantText = findFirstString(response);
        }
        if (!assistantText) assistantText = '[Không có nội dung trả lời]';

        messagesEl.removeChild(typingIndicator);
        addMessageToCurrent('assistant', assistantText);
      }catch(err){
        messagesEl.removeChild(typingIndicator);
        addMessageToCurrent('assistant', 'Lỗi khi gọi AI: ' + (err?.message || String(err)));
      }finally{
        isTyping = false;
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }
    }

    // small helpers
    function uid(){ return 'id_'+Math.random().toString(36).slice(2,9); }

    // init
    loadConversations();

    // accessibility hint: focus prompt on load
    promptEl.focus();
  </script></body>
</html>