<!doctype html>

<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BooChat-A.I — Dark Red (Puter)</title>
  <style>
    :root{
      --bg:#070406;
      --card:#0b0b0c;
      --muted:#9aa4b2;
      --accent:#ff2d2d;
      --accent-2:#ff7a7a;
      --glass: rgba(255,255,255,0.03);
      --radius:14px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#050304 0%, #0b0b0c 100%);color:#fff}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}.app{width:100%;max-width:1100px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;padding:12px;display:grid;grid-template-columns:320px 1fr;gap:14px;box-shadow:0 20px 50px rgba(0,0,0,0.6);}

/* Sidebar */
.sidebar{background:var(--card);padding:12px;border-radius:12px;display:flex;flex-direction:column;gap:10px;height:80vh;min-height:520px}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:44px;height:44px;border-radius:9px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent),#8b0000);box-shadow:0 6px 20px rgba(255,45,45,0.12), inset 0 -6px 24px rgba(0,0,0,0.45)}
.logo b{font-size:18px}
.brand h3{margin:0;font-size:16px}
.brand p{margin:0;font-size:12px;color:var(--muted)}

.controls{display:flex;gap:8px}
.btn{flex:1;padding:8px 10px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
.btn.new{background:transparent;color:var(--accent);border:1px solid rgba(255,45,45,0.12)}
.btn.clear{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}

.convo-list{overflow:auto;padding:6px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);flex:1}
.convo-item{padding:8px;border-radius:10px;display:flex;flex-direction:column;gap:4px;margin-bottom:8px;cursor:pointer}
.convo-item:hover{background:linear-gradient(90deg, rgba(255,45,45,0.03), rgba(255,255,255,0.01))}
.convo-item .title{font-weight:700;color:#fff}
.convo-item .meta{font-size:12px;color:var(--muted)}

.small{font-size:12px;color:var(--muted)}

/* Chat area */
.chat{background:var(--glass);padding:16px;border-radius:12px;display:flex;flex-direction:column;height:80vh;min-height:520px}
.chat-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.chat-title{display:flex;gap:12px;align-items:center}
.chat-title h2{margin:0}
.chat-messages{flex:1;overflow:auto;padding:10px 6px;display:flex;flex-direction:column;gap:12px;margin-top:8px}

/* Bubbles */
.msg-wrapper{display:flex;flex-direction:column;max-width:100%}
.msg{display:inline-block;padding:12px 14px;border-radius:14px;line-height:1.4;white-space:pre-wrap;overflow-wrap:break-word;word-break:break-word;box-shadow:0 6px 18px rgba(0,0,0,0.4)}
.user{align-self:flex-end;background:linear-gradient(180deg,#0b1220,#081020);border:1px solid rgba(255,255,255,0.03);color:#fff;max-width:78%}
.assistant{align-self:flex-start;background:linear-gradient(180deg, rgba(255,45,45,0.06), rgba(255,45,45,0.03));border:1px solid rgba(255,45,45,0.12);color:#fff;max-width:78%}
.meta{font-size:11px;color:var(--muted);margin-top:6px;text-align:right}

.composer{display:flex;gap:10px;margin-top:12px}
.input-wrap{flex:1;display:flex;flex-direction:column}
textarea#prompt{width:100%;min-height:84px;max-height:220px;border-radius:12px;padding:12px;border:none;background:transparent;color:#fff;outline:none;resize:vertical;font-size:15px}
.send-row{display:flex;gap:8px;align-items:center;margin-top:8px}
.send-btn{padding:10px 14px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));font-weight:700;cursor:pointer;box-shadow:0 6px 30px rgba(255,45,45,0.12)}
.muted-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:8px 10px;border-radius:10px;cursor:pointer}

/* responsive */
@media (max-width:980px){
  .app{grid-template-columns:1fr;}
  .sidebar{order:2;height:auto}
  .chat{order:1;height:70vh}
  .logo{width:40px;height:40px}
  textarea#prompt{min-height:72px}
  .user,.assistant{max-width:92%}
}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="app" role="application">
      <aside class="sidebar" aria-label="Sidebar">
        <div class="brand">
          <div class="logo"><b>DTN</b></div>
          <div>
            <h3>BooChat-A.I</h3>
            <p>AI nhỏ gọn — Cảm Hứng từ openAI, phát triển bởi DTN.Bo</p>
          </div>
        </div><div class="controls">
      <button class="btn new" id="newConvoBtn">+ Cuộc trò chuyện mới</button>
      <button class="btn clear" id="clearAllBtn">Xoá tất cả</button>
    </div>

    <div class="convo-list" id="convoList" aria-live="polite"></div>

    <div class="small" style="margin-top:6px;display:flex;justify-content:space-between;align-items:center">
      <span>Phiên bản: local • 17.5.9.1</span>
      <div style="display:flex;gap:6px">
        <button class="muted-btn" id="exportBtn">Xuất</button>
        <button class="muted-btn" id="importBtn">Nhập</button>
      </div>
    </div>
  </aside>

  <main class="chat">
    <div class="chat-header">
      <div class="chat-title">
        <h2 id="chatTitle">Cuộc trò chuyện mới</h2>
        <div class="small" id="chatMeta">Chưa có tin nhắn</div>
      </div>
      <div class="meta-actions">
        <button class="muted-btn" id="copyConvBtn">Sao chép</button>
        <button class="muted-btn" id="deleteConvBtn">Xoá</button>
      </div>
    </div>

    <div class="chat-messages" id="messages" role="log" aria-live="polite"></div>

    <div class="composer">
      <div class="input-wrap">
        <textarea id="prompt" placeholder="Gõ câu hỏi của bạn... (Enter gửi — Shift+Enter xuống dòng)"></textarea>
        <div class="send-row">
          <button class="send-btn" id="askBtn">Gửi</button>
          <button class="muted-btn" id="regenBtn">Tạo lại</button>
          <div style="flex:1;text-align:right;color:var(--muted);font-size:13px">Lưu tại thiết bị • Tải câu trả lời</div>
        </div>
      </div>
    </div>
  </main>
</div>

  </div>  <!-- Puter.js -->  <script src="https://js.puter.com/v2/"></script>  <script>
    const STORAGE_KEY = 'boochat_conversations_v1';
    const convoListEl = document.getElementById('convoList');
    const messagesEl = document.getElementById('messages');
    const chatTitleEl = document.getElementById('chatTitle');
    const chatMetaEl = document.getElementById('chatMeta');
    const promptEl = document.getElementById('prompt');
    const askBtn = document.getElementById('askBtn');
    const newConvoBtn = document.getElementById('newConvoBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const copyConvBtn = document.getElementById('copyConvBtn');
    const deleteConvBtn = document.getElementById('deleteConvBtn');
    const regenBtn = document.getElementById('regenBtn');

    let conversations = [];
    let currentConvoId = null;
    let isTyping = false;

    function createEmptyConvo(){ return { id: 'c_'+Date.now(), title: 'Cuộc trò chuyện ' + (conversations?.length+1 || 1), createdAt: Date.now(), messages: [] }; }

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(conversations)); }
    function load(){ try{ const raw = localStorage.getItem(STORAGE_KEY); conversations = raw ? JSON.parse(raw) : []; }catch(e){ conversations = []; } if(!Array.isArray(conversations) || conversations.length===0) conversations = [createEmptyConvo()]; currentConvoId = conversations[0].id; save(); renderConvoList(); renderCurrentConversation(); }

    function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    function formatMessageBody(text){ if(!text) return ''; let out = escapeHtml(text); out = out.replace(/```([\s\S]*?)```/g, function(m,p){ return `<pre style="background:#0b0b0c;padding:8px;border-radius:8px;overflow:auto">${p}</pre>`; }); out = out.replace(/`([^`]+)`/g, '<code style="background:rgba(255,255,255,0.03);padding:2px 6px;border-radius:6px">$1</code>'); out = out.replace(/\n/g, '<br>'); return out; }function renderConvoList(){ convoListEl.innerHTML=''; conversations.slice().reverse().forEach(conv=>{ const el=document.createElement('div'); el.className='convo-item'; el.dataset.id=conv.id; el.innerHTML=`<div class="title">${escapeHtml(conv.title)}</div><div class="meta">${conv.messages.length} tin • ${new Date(conv.createdAt).toLocaleString('vi-VN')}</div>`; el.addEventListener('click', ()=>{ currentConvoId = conv.id; renderCurrentConversation(); }); convoListEl.appendChild(el); }); }

function renderCurrentConversation(){ const convo = conversations.find(c=>c.id===currentConvoId) || conversations[0]; if(!convo) return; chatTitleEl.textContent = convo.title; chatMetaEl.textContent = convo.messages.length ? (new Date(convo.messages[convo.messages.length-1].at).toLocaleString('vi-VN')) : 'Chưa có tin nhắn'; messagesEl.innerHTML=''; convo.messages.forEach(m=>{ const wrap = document.createElement('div'); wrap.className='msg-wrapper'; const div=document.createElement('div'); div.className='msg ' + (m.role==='user' ? 'user' : 'assistant'); div.innerHTML = `<div class="body">${formatMessageBody(m.text)}</div>`; const meta = document.createElement('div'); meta.className='meta'; meta.textContent = new Date(m.at).toLocaleString('vi-VN'); wrap.appendChild(div); wrap.appendChild(meta); messagesEl.appendChild(wrap); }); messagesEl.scrollTop = messagesEl.scrollHeight; }

function addMessageToCurrent(role, text){ const convo = conversations.find(c=>c.id===currentConvoId) || conversations[0]; convo.messages.push({ role, text, at: Date.now() }); const firstUser = convo.messages.find(m=>m.role==='user'); if(firstUser) convo.title = firstUser.text.slice(0,40); save(); renderConvoList(); renderCurrentConversation(); }

newConvoBtn.addEventListener('click', ()=>{ const c=createEmptyConvo(); conversations.push(c); currentConvoId=c.id; save(); renderConvoList(); renderCurrentConversation(); promptEl.focus(); });
clearAllBtn.addEventListener('click', ()=>{ if(!confirm('Xoá toàn bộ cuộc trò chuyện trên thiết bị?')) return; conversations=[]; conversations.push(createEmptyConvo()); currentConvoId=conversations[0].id; save(); renderConvoList(); renderCurrentConversation(); });

exportBtn.addEventListener('click', ()=>{ const dataStr=JSON.stringify(conversations,null,2); const blob=new Blob([dataStr],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='boochat_export_'+Date.now()+'.json'; a.click(); URL.revokeObjectURL(url); });

importBtn.addEventListener('click', ()=>{ const input=document.createElement('input'); input.type='file'; input.accept='.json,application/json'; input.onchange=(ev)=>{ const f=ev.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>{ try{ const imported=JSON.parse(reader.result); if(Array.isArray(imported)){ conversations=imported; currentConvoId = conversations[0]?.id || createEmptyConvo().id; save(); renderConvoList(); renderCurrentConversation(); alert('Nhập thành công.'); } else alert('Tập tin không hợp lệ.'); }catch(e){ alert('Lỗi đọc tập tin.'); } }; reader.readAsText(f); }; input.click(); });

copyConvBtn.addEventListener('click', ()=>{ const convo = conversations.find(c=>c.id===currentConvoId); if(!convo) return; const text = convo.messages.map(m=>`[${m.role}] ${new Date(m.at).toLocaleString('vi-VN')}: ${m.text}`).join('\n\n'); navigator.clipboard?.writeText(text).then(()=>alert('Đã sao chép cuộc trò chuyện')).catch(()=>alert('Không thể sao chép')); });

deleteConvBtn.addEventListener('click', ()=>{ if(!confirm('Xoá cuộc trò chuyện này?')) return; conversations = conversations.filter(c=>c.id!==currentConvoId); if(conversations.length===0) conversations.push(createEmptyConvo()); currentConvoId = conversations[0].id; save(); renderConvoList(); renderCurrentConversation(); });

regenBtn.addEventListener('click', async ()=>{ const convo = conversations.find(c=>c.id===currentConvoId); if(!convo) return; const lastUser = [...convo.messages].reverse().find(m=>m.role==='user'); if(!lastUser){ alert('Không có tin nhắn người dùng để tạo lại.'); return; } promptEl.value = lastUser.text; sendPrompt(); });

// Robust extractor
function extractAssistantText(response){ if(response==null) return null; if(typeof response==='string') return response; if(response.message && (typeof response.message === 'string' || typeof response.message?.content === 'string')) return typeof response.message==='string' ? response.message : response.message.content; if(response.choices && Array.isArray(response.choices) && response.choices.length){ const ch=response.choices[0]; if(ch.message && typeof ch.message?.content === 'string') return ch.message.content; if(ch.text && typeof ch.text==='string') return ch.text; } if(response.content){ if(typeof response.content==='string') return response.content; if(Array.isArray(response.content)) return response.content.map(c=> typeof c==='string'?c:(c?.text||'')).join('\n'); } if(response.text && typeof response.text==='string') return response.text; const seen=new WeakSet(); function findString(obj){ if(obj==null) return null; if(typeof obj==='string') return obj; if(typeof obj!=='object') return null; if(seen.has(obj)) return null; seen.add(obj); if(Array.isArray(obj)){ for(const el of obj){ const s=findString(el); if(s) return s; } } else { const pref=['content','text','message','output','result','reply']; for(const k of pref) if(obj[k]){ const s=findString(obj[k]); if(s) return s; } for(const k in obj){ const s=findString(obj[k]); if(s) return s; } } return null; } return findString(response); }

async function sendPrompt(){
  const prompt = promptEl.value.trim(); if(!prompt) return; if(isTyping) return alert('Đang chờ phản hồi — vui lòng đợi.');
  addMessageToCurrent('user', prompt); promptEl.value=''; isTyping=true;

  const typingIndicatorWrap = document.createElement('div'); typingIndicatorWrap.className='msg-wrapper'; const typingIndicator=document.createElement('div'); typingIndicator.className='msg assistant'; typingIndicator.innerHTML=`<div class="body"><em class="typing">⏳ Đang tạo phản hồi...</em></div>`; const typingMeta=document.createElement('div'); typingMeta.className='meta'; typingMeta.textContent='…'; typingIndicatorWrap.appendChild(typingIndicator); typingIndicatorWrap.appendChild(typingMeta); messagesEl.appendChild(typingIndicatorWrap); messagesEl.scrollTop = messagesEl.scrollHeight;

  try{
    let response = null;
    try{
    const response = await fetch("https://00cd1052-a412-4ea9-a768-5cee607ff3ec-00-100shs7nm9x8k.worf.replit.dev/getkey", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt: prompt })
}).then(res => res.json());
    }catch(e){
      response = await puter.ai.chat(prompt, { model: 'gpt-4.1-nano', max_tokens: 1200 });
    }

    const assistantText = extractAssistantText(response) || '[Không có nội dung trả lời]';
    if(typingIndicatorWrap.parentNode) typingIndicatorWrap.parentNode.removeChild(typingIndicatorWrap);
    addMessageToCurrent('assistant', assistantText);
  }catch(err){
    if(typingIndicatorWrap.parentNode) typingIndicatorWrap.parentNode.removeChild(typingIndicatorWrap);
    addMessageToCurrent('assistant', 'Lỗi khi gọi AI: ' + (err?.message || String(err)));
  }finally{ isTyping=false; messagesEl.scrollTop = messagesEl.scrollHeight; }
}

// init
load(); promptEl.focus();

// keyboard
promptEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendPrompt(); } });
askBtn.addEventListener('click', sendPrompt);

  </script>
</body>
</html>